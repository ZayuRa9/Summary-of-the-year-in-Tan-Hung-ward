<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Quay Số Tết</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:Arial,Helvetica,sans-serif}
body{
  background:url("IM1.png") center/cover no-repeat fixed;
  display:flex;flex-direction:column;justify-content:space-between;
}
#main{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
}
#number{
  font-size:18vw;
  font-weight:900;
  color:#ffd700;
  text-shadow:0 0 10px #000;
}
#controls{
  position:absolute;
  bottom:18%;
  left:50%;
  transform:translateX(-50%);
}
.btn{
  padding:14px 36px;
  border-radius:20px;
  border:2px solid #ffd700;
  background:rgba(180,0,0,0.75);
  color:#ffd700;
  font-size:22px;
  cursor:pointer;
  transition:transform .1s;
}
.btn:active{transform:scale(.96)}
#results{
  padding:12px 24px;
  background:rgba(0,0,0,.45);
  color:#fff;
  font-size:20px;
}
.row{display:flex;gap:20px}
.row span:first-child{width:120px;font-weight:bold;color:#ffd700}

#backBtn{
  position:absolute;
  bottom:12px;left:12px;
  opacity:0;
  pointer-events:none;
}
body:hover #backBtn{
  opacity:1;
  pointer-events:auto;
}

#finalTable{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.85);
  color:#fff;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
#finalTable table{
  border-collapse:collapse;
  font-size:28px;
}
#finalTable th,#finalTable td{
  border:2px solid #ffd700;
  padding:10px 24px;
}
canvas{position:absolute;inset:0;pointer-events:none}
</style>
</head>
<body>
<canvas id="fx"></canvas>

<div id="main">
  <div id="number">000</div>
</div>

<div id="controls">
  <button id="spinBtn" class="btn">Quay số</button>
</div>

<button id="backBtn" class="btn">Quay lại</button>

<div id="results"></div>

<div id="finalTable">
  <h1 style="margin-bottom:20px;color:#ffd700">KẾT QUẢ CHƯƠNG TRÌNH</h1>
  <table>
    <thead><tr><th>SỐ</th><th>GIẢI</th></tr></thead>
    <tbody id="finalBody"></tbody>
  </table>
</div>

<audio id="rollSound" src="roll.mp3" loop></audio>
<audio id="stopSound" src="stop.mp3"></audio>
<audio id="drumSound" src="drum.mp3"></audio>
<audio id="fireSound" src="firecracker.mp3"></audio>

<script>
const prizes = [
  ...Array(7).fill("Khuyến khích"),
  "Giải Ba","Giải Nhì","Giải Đặc Biệt"
];

let pool = Array.from({length:400},(_,i)=>String(i+1).padStart(3,"0"));
let rolling=false, timer=null;
let results=[];
let prizeIndex=0;

const numEl=document.getElementById("number");
const resEl=document.getElementById("results");
const spinBtn=document.getElementById("spinBtn");
const backBtn=document.getElementById("backBtn");

const rollSound=document.getElementById("rollSound");
const stopSound=document.getElementById("stopSound");
const drumSound=document.getElementById("drumSound");
const fireSound=document.getElementById("fireSound");

function start(){
  if(rolling || prizeIndex>=prizes.length) return;
  rolling=true;
  rollSound.currentTime=0; rollSound.play();
  timer=setInterval(()=>{
    const r=pool[Math.floor(Math.random()*pool.length)];
    numEl.textContent=r;
  },40);
}
function stop(){
  if(!rolling) return;
  clearInterval(timer);
  rollSound.pause();
  const idx=Math.floor(Math.random()*pool.length);
  const n=pool.splice(idx,1)[0];
  const prize=prizes[prizeIndex++];
  numEl.textContent=n;

  if(prize==="Giải Đặc Biệt"){
    drumSound.play(); fireSound.play();
  }else stopSound.play();

  results.push({n,prize});
  renderResults();
  fireworks();

  if(prizeIndex===prizes.length){
    setTimeout(showFinal,1500);
  }
  rolling=false;
}
function toggle(){ rolling?stop():start(); }

function renderResults(){
  resEl.innerHTML=results.map(r=>`<div class="row"><span>${r.n}</span><span>${r.prize}</span></div>`).join("");
}

function showFinal(){
  const body=document.getElementById("finalBody");
  body.innerHTML=results.map(r=>`<tr><td>${r.n}</td><td>${r.prize}</td></tr>`).join("");
  document.getElementById("finalTable").style.display="flex";

  const csv="SỐ,GIẢI\n"+results.map(r=>`${r.n},${r.prize}`).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="ket-qua.csv";
  a.click();
}

backBtn.onclick=()=>{
  if(results.length===0) return;
  const last=results[results.length-1];
  if(last.prize==="Giải Đặc Biệt") return;
  pool.push(last.n);
  results.pop();
  prizeIndex--;
  renderResults();
};

spinBtn.onclick=toggle;
document.addEventListener("keydown",e=>{
  if(e.code==="Space"){e.preventDefault();toggle();}
});

/* Pháo hoa nhẹ */
const canvas=document.getElementById("fx");
const ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
window.onresize=resize; resize();
function fireworks(){
  let parts=[];
  for(let i=0;i<80;i++){
    parts.push({
      x:canvas.width/2,y:canvas.height/2,
      vx:(Math.random()-0.5)*6,
      vy:(Math.random()-0.5)*6,
      a:1
    });
  }
  const t=setInterval(()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    parts.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy; p.a-=0.02;
      ctx.fillStyle=`rgba(255,215,0,${p.a})`;
      ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
    });
    parts=parts.filter(p=>p.a>0);
    if(parts.length===0){clearInterval(t);ctx.clearRect(0,0,canvas.width,canvas.height);}
  },30);
}
</script>
</body>
</html>
